{
  "bug_summary": "Departures API/UI shows 'no upcoming departures' despite GTFS static timetable data existing - missing calendar weekday filtering in SQL query",
  "affected_phases": [
    {
      "phase": 2,
      "confidence": 0.95,
      "reason": "Real-time departures feature implemented in Phase 2 (Checkpoint 4: Real-Time Departures Service, Checkpoint 5: Update Stops API). Backend static schedule query created in realtime_service.py lines 143-167"
    },
    {
      "phase": 2.1,
      "confidence": 0.6,
      "reason": "Phase 2.1 added platform/wheelchair fields to departures response (Checkpoint 2: Real Departures Integration). Modified realtime_service.py but did not alter static schedule logic"
    }
  ],
  "affected_systems": [
    {
      "system": "Backend Departures SQL Query - Missing Weekday Filter",
      "layer": "Backend Service",
      "files": [
        "backend/app/services/realtime_service.py:143-167"
      ],
      "description": "SQL query joins calendar table but only checks start_date/end_date ranges. Missing WHERE clause for weekday boolean columns (monday, tuesday, etc.) based on current day of week. Query returns 0 rows on days when calendar.{weekday} = false for all matching service_ids"
    },
    {
      "system": "Backend Departures API Endpoint",
      "layer": "Backend API",
      "files": [
        "backend/app/api/v1/stops.py:176-261"
      ],
      "description": "GET /stops/{stop_id}/departures calls get_realtime_departures() which returns empty list when static query fails. No weekday-aware logic in API layer (delegated to service layer)"
    },
    {
      "system": "iOS Departures Repository - Offline Fallback",
      "layer": "iOS Data Layer",
      "files": [
        "SydneyTransit/SydneyTransit/Data/Repositories/DeparturesRepository.swift:16-49"
      ],
      "description": "fetchDepartures() tries API first, falls back to DatabaseManager.shared.getDepartures() on empty/error. Offline query also missing weekday filter in pattern_stops join"
    },
    {
      "system": "iOS DatabaseManager - GRDB Static Query",
      "layer": "iOS Database",
      "files": [
        "SydneyTransit/SydneyTransit/Core/Database/DatabaseManager.swift:69-116"
      ],
      "description": "getDepartures() queries pattern_stops without calendar join. Missing weekday validation - returns trips regardless of service calendar day restrictions"
    },
    {
      "system": "iOS DeparturesView - Empty State Display",
      "layer": "iOS UI",
      "files": [
        "SydneyTransit/SydneyTransit/Features/Departures/DeparturesView.swift:1-68"
      ],
      "description": "Shows 'No upcoming departures' when viewModel.departures.isEmpty (line 18-21). Correctly displays empty state but underlying data query is broken"
    }
  ],
  "data_flow_layers": {
    "backend": [
      "1. API Endpoint: backend/app/api/v1/stops.py:176 - get_departures()",
      "2. Service Layer: backend/app/services/realtime_service.py:87 - get_realtime_departures()",
      "3. SQL Query: realtime_service.py:143-167 - pattern_stops JOIN calendar (MISSING weekday filter)",
      "4. Database: Supabase calendar table (schema: schemas/migrations/001_initial_schema.sql:101-111)",
      "5. Response: Empty departures list returned to iOS"
    ],
    "ios": [
      "1. View: DeparturesView.swift:36-48 - onAppear() → loadDepartures()",
      "2. ViewModel: DeparturesViewModel (not shown, calls repository)",
      "3. Repository: DeparturesRepository.swift:16 - fetchDepartures() → API call",
      "4. Fallback: DatabaseManager.swift:69 - getDepartures() from GRDB (also broken)",
      "5. UI: DeparturesView.swift:18-21 - Empty state 'No upcoming departures'"
    ]
  },
  "root_cause_hypothesis": "Backend SQL query (realtime_service.py:143-167) joins calendar table but only filters by date range (start_date/end_date). Missing WHERE clause to match current weekday (e.g., 'AND c.monday = true' for Mondays). iOS offline query also missing calendar weekday logic. Result: 0 trips returned even when valid schedules exist for current day",
  "keywords": [
    "departures",
    "calendar",
    "weekday",
    "monday",
    "tuesday",
    "wednesday",
    "thursday",
    "friday",
    "saturday",
    "sunday",
    "service_id",
    "static",
    "schedule",
    "pattern_stops",
    "get_realtime_departures"
  ],
  "primary_phase": 2,
  "search_summary": {
    "total_files_scanned": 8,
    "critical_files_identified": 5,
    "backend_files": 2,
    "ios_files": 3,
    "schema_files": 1
  },
  "static_vs_realtime_split": {
    "exists": true,
    "description": "Backend realtime_service.py has two-step process: (1) Fetch static schedules from pattern_stops+calendar (lines 143-174), (2) Merge Redis real-time delays (lines 176-240). Both API and iOS offline fallback use static data as baseline. Real-time only adds delay_s to existing static departures",
    "bug_affects": "Static schedule query (step 1) - returns empty, so real-time merge never happens"
  },
  "next_stage_action": "Stage 3 (Diagnosis) should examine calendar table data and test SQL query with/without weekday filter to confirm missing WHERE clause is root cause"
}
