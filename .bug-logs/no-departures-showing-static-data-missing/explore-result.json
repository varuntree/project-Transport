{
  "data_flow": [
    {
      "layer": "iOS UI",
      "component": "StopDetailsView (Line 89-91)",
      "file": "/Users/varunprasad/code/prjs/prj_transport/SydneyTransit/SydneyTransit/Features/Stops/StopDetailsView.swift",
      "line_range": "89-91",
      "purpose": "NavigationLink to DeparturesView, passes Stop object with sid (internal SQLite ID)"
    },
    {
      "layer": "iOS UI",
      "component": "DeparturesView.onAppear (Line 36-64)",
      "file": "/Users/varunprasad/code/prjs/prj_transport/SydneyTransit/SydneyTransit/Features/Departures/DeparturesView.swift",
      "line_range": "36-64",
      "purpose": "Converts Stop.sid to GTFS stop_id via dict_stop table, then calls viewModel.loadDepartures(stopId: gtfsStopId)"
    },
    {
      "layer": "iOS ViewModel",
      "component": "DeparturesViewModel.loadDepartures (Line 16-41)",
      "file": "/Users/varunprasad/code/prjs/prj_transport/SydneyTransit/SydneyTransit/Features/Departures/DeparturesViewModel.swift",
      "line_range": "16-41",
      "purpose": "Calls repository.fetchDepartures(stopId) with GTFS stop_id string"
    },
    {
      "layer": "iOS Repository",
      "component": "DeparturesRepository.fetchDepartures (Line 16-49)",
      "file": "/Users/varunprasad/code/prjs/prj_transport/SydneyTransit/SydneyTransit/Data/Repositories/DeparturesRepository.swift",
      "line_range": "16-49",
      "purpose": "CRITICAL BRANCH: Tries backend API first, if empty OR error → fallback to DatabaseManager.getDepartures (offline GRDB)"
    },
    {
      "layer": "iOS Offline DB",
      "component": "DatabaseManager.getDepartures (Line 69-116)",
      "file": "/Users/varunprasad/code/prjs/prj_transport/SydneyTransit/SydneyTransit/Core/Database/DatabaseManager.swift",
      "line_range": "69-116",
      "purpose": "CRITICAL BUG: Query joins pattern_stops → patterns → trips → routes, but WHERE clause uses dict_stop subquery. For stop_id='200060' (Central Station, sid=709), query returns 0 trips because pattern_stops has 0 rows with sid=709."
    },
    {
      "layer": "Backend API",
      "component": "GET /api/v1/stops/{stop_id}/departures (Line 176-293)",
      "file": "/Users/varunprasad/code/prjs/prj_transport/backend/app/api/v1/stops.py",
      "line_range": "176-293",
      "purpose": "Validates stop exists in Supabase stops table, calls get_realtime_departures service"
    },
    {
      "layer": "Backend Service",
      "component": "get_realtime_departures (Line 87-288)",
      "file": "/Users/varunprasad/code/prjs/prj_transport/backend/app/services/realtime_service.py",
      "line_range": "87-288",
      "purpose": "CRITICAL: Queries Supabase pattern_stops → patterns → trips → routes → calendar. Uses stop_id='200060' in WHERE ps.stop_id = '{stop_id}'. Fetches static schedules, merges with Redis GTFS-RT delays."
    },
    {
      "layer": "Database Query (Backend)",
      "component": "Supabase SQL query (Line 143-167)",
      "file": "/Users/varunprasad/code/prjs/prj_transport/backend/app/services/realtime_service.py",
      "line_range": "143-167",
      "purpose": "USES STATIC GTFS: Query selects from pattern_stops table (364,863 rows in Supabase), filters by stop_id (GTFS string), departure_offset_secs >= time_secs, calendar date range. Returns static schedules as baseline."
    },
    {
      "layer": "Database Query (iOS Offline)",
      "component": "GRDB SQLite query (Line 80-98)",
      "file": "/Users/varunprasad/code/prjs/prj_transport/SydneyTransit/SydneyTransit/Core/Database/DatabaseManager.swift",
      "line_range": "80-98",
      "purpose": "CRITICAL BUG: Query pattern_stops with WHERE ps.sid = (SELECT sid FROM dict_stop WHERE stop_id = ?). For Central Station stop_id='200060', dict_stop returns sid=709, but pattern_stops table has 0 rows where sid=709 (iOS DB schema mismatch with Supabase)."
    }
  ],
  "relevant_files": [
    {
      "path": "/Users/varunprasad/code/prjs/prj_transport/backend/app/services/realtime_service.py",
      "reason": "Backend departures service - DOES query static GTFS pattern_stops table (line 156: WHERE ps.stop_id = '{stop_id}')",
      "critical_sections": [
        "L87-288: get_realtime_departures() - main function",
        "L143-167: Static schedule SQL query - USES pattern_stops table",
        "L176-217: Redis GTFS-RT blob fetch and merge logic"
      ]
    },
    {
      "path": "/Users/varunprasad/code/prjs/prj_transport/SydneyTransit/SydneyTransit/Core/Database/DatabaseManager.swift",
      "reason": "iOS offline departures - BUG HERE: Query returns 0 results due to iOS DB schema using sid (integer) but pattern_stops has no rows for Central Station sid=709",
      "critical_sections": [
        "L69-116: getDepartures() - offline fallback query",
        "L91: WHERE ps.sid = (SELECT sid FROM dict_stop WHERE stop_id = ?) - CRITICAL BUG"
      ]
    },
    {
      "path": "/Users/varunprasad/code/prjs/prj_transport/SydneyTransit/SydneyTransit/Data/Repositories/DeparturesRepository.swift",
      "reason": "iOS repository - implements fallback logic (API → offline DB)",
      "critical_sections": [
        "L16-49: fetchDepartures() - tries API first, falls back to DatabaseManager on empty/error"
      ]
    },
    {
      "path": "/Users/varunprasad/code/prjs/prj_transport/backend/app/api/v1/stops.py",
      "reason": "Backend API endpoint - validates stop exists, calls realtime service",
      "critical_sections": [
        "L176-293: GET /stops/{stop_id}/departures endpoint"
      ]
    },
    {
      "path": "/Users/varunprasad/code/prjs/prj_transport/backend/app/services/ios_db_generator.py",
      "reason": "Generates iOS SQLite database from Supabase data - need to verify pattern_stops generation logic",
      "critical_sections": ["Unknown - file needs inspection"]
    }
  ],
  "gtfs_static_data_status": {
    "backend_supabase": {
      "tables_exist": "yes",
      "data_loaded": "yes",
      "stop_times_table": "NO - using pattern model instead (364,863 rows in pattern_stops)",
      "queried_by_api": "yes - realtime_service.py line 156 queries pattern_stops table",
      "evidence": [
        "Checkpoint 4 validation: 364,863 rows in pattern_stops, 171,534 trips, 12,005 patterns",
        "Backend query: WHERE ps.stop_id = '{stop_id}' (uses GTFS stop_id string)",
        "Phase 2 completion: Static schedules successfully merged with GTFS-RT in departures API"
      ]
    },
    "ios_grdb_offline": {
      "tables_exist": "yes",
      "data_loaded": "partial - 364,863 rows in pattern_stops, but iOS DB uses sid (integer) not stop_id (string)",
      "stop_times_table": "NO - using pattern model (same as backend)",
      "queried_by_api": "yes - BUT BROKEN: DatabaseManager.getDepartures queries pattern_stops WHERE ps.sid = X, but iOS DB has 0 trips for Central Station sid=709",
      "evidence": [
        "iOS DB: dict_stop maps stop_id='200060' → sid=709",
        "iOS DB: pattern_stops has 364,863 rows total",
        "iOS DB: COUNT trips WHERE ps.sid=709 → 0 results (BUG)",
        "iOS DB: pattern_stops has sid column, but no rows for Central Station (possible data loading issue)",
        "Backend DB: Uses stop_id (string) directly in WHERE clause, works correctly"
      ]
    }
  },
  "root_cause": {
    "summary": "iOS offline database (GRDB) has 0 pattern_stops rows for Central Station (sid=709) despite dict_stop mapping existing. Backend Supabase uses stop_id (string) directly and has correct data. iOS-to-Supabase schema mismatch OR incomplete data generation.",
    "hypothesis_validated": "FALSE - Backend DOES query static GTFS data (pattern_stops table) successfully. Bug is iOS-specific.",
    "actual_bug": "iOS DatabaseManager.getDepartures query returns 0 results because pattern_stops table in iOS SQLite has 0 trips for Central Station sid=709. Backend Supabase pattern_stops table uses stop_id (string) and has data. Schema mismatch between iOS (sid integer) and Supabase (stop_id string).",
    "secondary_issue": "Backend API may be returning empty results OR timing out, causing iOS to fall back to broken offline DB. Need to test backend API response for stop_id='200060'."
  },
  "phase_artifacts": [
    {
      "file": ".phase-logs/phase-2/phase-completion.json",
      "finding": "Checkpoint 4 (Real-Time Departures Service) marked complete with 364,863 pattern_stops rows loaded to Supabase. Backend merges static + RT successfully."
    },
    {
      "file": "backend/checkpoint_4_validation_output.txt",
      "finding": "GTFS pipeline uses pattern model (not stop_times table), 12,005 patterns, 364,863 pattern_stops rows, compression factor 1:14.3"
    },
    {
      "file": "specs/phase-2-1-fixes-plan.md",
      "finding": "Checkpoint 1 planned to fix time filtering (show future departures only), not data availability bug. This is a NEW bug not covered by phase 2.1 fixes."
    },
    {
      "file": "specs/issue-145-adw-phase2-1-sdlc_planner-missing-modalities-dispatches.md",
      "finding": "Related issue: Missing multi-mode stops (buses, ferries, light rail). Root cause: GTFS-RT poller crashes + partial static load. iOS DB integrity issues."
    }
  ],
  "ios_db_verification": {
    "gtfs_db_size": "36MB",
    "tables": [
      "calendar", "calendar_dates", "dict_pattern", "dict_route", "dict_stop",
      "metadata", "pattern_stops", "patterns", "routes", "stops", "trips",
      "stops_fts (FTS5 search index)"
    ],
    "pattern_stops_count": 364863,
    "central_station_mapping": {
      "stop_id": "200060",
      "sid": 709,
      "stop_name": "Central Station",
      "trips_count": 0,
      "expected_trips": ">100 (Central Station is major hub)"
    },
    "departures_by_route_type": {
      "2 (rail)": 58556,
      "4 (ferry)": 1649,
      "401 (metro)": 199,
      "700 (bus)": 193400,
      "712 (school bus)": 110307,
      "714 (regional bus)": 706,
      "900 (light rail)": 46
    }
  },
  "exploration_summary": "Traced 9-layer data flow from iOS UI → ViewModel → Repository → Backend API → Supabase DB. FOUND: Backend DOES query static GTFS pattern_stops table successfully (realtime_service.py L156). Bug isolated to iOS offline fallback: DatabaseManager.getDepartures returns 0 results for Central Station (stop_id='200060', sid=709) because iOS SQLite pattern_stops table has 0 trips for sid=709 despite 364,863 total rows. Schema mismatch: Backend uses stop_id (string), iOS uses sid (integer). Possible causes: (1) ios_db_generator.py incomplete data transformation, (2) Backend API returns empty forcing iOS offline fallback, (3) Trip-to-stop linking broken in iOS DB generation. Need to inspect ios_db_generator.py and test backend API response.",
  "critical_questions_answered": {
    "q1_backend_queries_static_gtfs": "YES - realtime_service.py line 143-167 queries pattern_stops table with stop_id filter, merges with Redis GTFS-RT delays",
    "q2_ios_uses_local_grdb": "YES - DeparturesRepository falls back to DatabaseManager.getDepartures on API empty/error. But offline query BROKEN for Central Station.",
    "q3_gtfs_static_data_loaded": "YES (Backend Supabase), PARTIAL (iOS SQLite - data exists but sid=709 has 0 trips)"
  },
  "next_investigation_steps": [
    "Test backend API: curl http://localhost:8000/api/v1/stops/200060/departures - check if returns data or empty",
    "Read ios_db_generator.py to understand how Supabase pattern_stops (stop_id string) transforms to iOS pattern_stops (sid integer)",
    "Check iOS pattern_stops table: SELECT COUNT(*) FROM pattern_stops WHERE sid IN (SELECT sid FROM dict_stop WHERE stop_id IN ('200060', '200062', '200063')) - verify Central Station bus stops have data",
    "Inspect iOS trips table: SELECT COUNT(*) FROM trips WHERE pid IN (SELECT pid FROM pattern_stops WHERE sid=709) - check if trips exist but pattern_stops link missing"
  ]
}
