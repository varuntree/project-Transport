{
  "plan_type": "CUSTOM",
  "plan_name": "phase-2-1-feature-completion",
  "description": "Complete partial features from Phase 2 (stop search details, departures list, trip details, route categorization, alphabetical navigation)",
  "context_summary": "Phase 2 implemented real-time GTFS-RT polling and basic departures API, but left UI features partially complete. Stop search shows results but no transport icons or real departures integration. Route list displays flat list without modality grouping or alphabetical index. This intermediary phase completes basic functionality before Phase 3 user features.",
  "affected_systems": [
    {
      "system": "iOS Stop Search (Features/Search/SearchView.swift)",
      "current_state": "Search works via GRDB FTS5, shows stop name/code, navigates to StopDetailsView with hardcoded placeholder departures",
      "gap": "Missing: stop type icons in search results, real departures integration (DeparturesView exists but not wired from StopDetailsView), trip details view",
      "files_affected": [
        "/Users/varunprasad/code/prjs/prj_transport/SydneyTransit/SydneyTransit/Features/Search/SearchView.swift",
        "/Users/varunprasad/code/prjs/prj_transport/SydneyTransit/SydneyTransit/Features/Stops/StopDetailsView.swift",
        "/Users/varunprasad/code/prjs/prj_transport/SydneyTransit/SydneyTransit/Data/Models/Stop.swift"
      ]
    },
    {
      "system": "iOS Departures View (Features/Departures/DeparturesView.swift)",
      "current_state": "DeparturesView implemented with auto-refresh, DepartureRow displays route badge/headsign/countdown, uses DeparturesViewModel + DeparturesRepository",
      "gap": "Not navigable from StopDetailsView (line 83-101 shows hardcoded placeholders). Missing: accessibility info display, all available API data (platform, wheelchair), trip details navigation",
      "files_affected": [
        "/Users/varunprasad/code/prjs/prj_transport/SydneyTransit/SydneyTransit/Features/Departures/DeparturesView.swift",
        "/Users/varunprasad/code/prjs/prj_transport/SydneyTransit/SydneyTransit/Features/Stops/StopDetailsView.swift",
        "/Users/varunprasad/code/prjs/prj_transport/SydneyTransit/SydneyTransit/Data/Models/Departure.swift"
      ]
    },
    {
      "system": "iOS Route List (Features/Routes/RouteListView.swift)",
      "current_state": "Flat list of all routes grouped by RouteType sections (rail/metro/bus/ferry/tram), sorted by priority, displays route badges with colors",
      "gap": "Missing: modality filter/picker (user must see all types at once), alphabetical A-Z index navigation (SwiftUI List sectionIndexTitles)",
      "files_affected": [
        "/Users/varunprasad/code/prjs/prj_transport/SydneyTransit/SydneyTransit/Features/Routes/RouteListView.swift",
        "/Users/varunprasad/code/prjs/prj_transport/SydneyTransit/SydneyTransit/Data/Models/Route.swift"
      ]
    },
    {
      "system": "Backend Departures API (backend/app/api/v1/stops.py)",
      "current_state": "GET /stops/{stop_id}/departures exists (line 176-261), returns trip_id/route_short_name/headsign/scheduled_time_secs/realtime_time_secs/delay_s/realtime from get_realtime_departures service",
      "gap": "Missing fields in response: platform, wheelchair_accessible, occupancy_status, route_color. Need to verify trip details endpoint exists (likely missing GET /trips/{trip_id})",
      "files_affected": [
        "/Users/varunprasad/code/prjs/prj_transport/backend/app/api/v1/stops.py",
        "/Users/varunprasad/code/prjs/prj_transport/backend/app/services/realtime_service.py",
        "/Users/varunprasad/code/prjs/prj_transport/backend/app/models/stops.py"
      ]
    },
    {
      "system": "Backend Trip Details API (backend/app/api/v1/trips.py)",
      "current_state": "Unknown - file not found in glob results, likely not implemented",
      "gap": "Need to create GET /trips/{trip_id} endpoint returning: trip metadata, stop_times sequence (stop_id, stop_name, arrival_time_secs, platform, wheelchair_accessible), route info",
      "files_affected": [
        "/Users/varunprasad/code/prjs/prj_transport/backend/app/api/v1/trips.py",
        "/Users/varunprasad/code/prjs/prj_transport/backend/app/models/trips.py"
      ]
    }
  ],
  "key_decisions": [
    {
      "decision": "Use SF Symbols for transport mode icons in search results",
      "rationale": "Native iOS, free, supports accessibility (VoiceOver labels), no asset management, GTFS route_type maps cleanly to SF Symbol names",
      "reference": "IOS_APP_SPECIFICATION.md Section 5.1 (native capabilities), DEVELOPMENT_STANDARDS.md iOS UI Components",
      "critical_constraint": "Must map GTFS route_type (0=tram, 1=metro, 2=rail, 3=bus, 4=ferry) to SF Symbol names (tram.fill, lightrail.fill, train.side.front.car, bus.fill, ferry.fill)"
    },
    {
      "decision": "SwiftUI List with sectionIndexTitles for alphabetical A-Z navigation",
      "rationale": "Native SwiftUI pattern for contacts-style A-Z index, supports accessibility, no custom gesture handling needed",
      "reference": "IOS_APP_SPECIFICATION.md Section 3 (iOS patterns), Apple SwiftUI List documentation",
      "critical_constraint": "Routes must be sorted alphabetically within each modality section, section headers must be single-letter strings (A, B, C...)"
    },
    {
      "decision": "Repository pattern for TripRepository (protocol + async/await)",
      "rationale": "Matches existing architecture (StopRepository, DeparturesRepository already use this pattern), offline-first with API fallback",
      "reference": "DEVELOPMENT_STANDARDS.md Section 6 (iOS Data Flow), IOS_APP_SPECIFICATION.md Section 4.3 (Repository Pattern example)",
      "critical_constraint": "Protocol TripRepositoryProtocol with async throws, implementation tries GRDB first (if trip data bundled) then APIClient fallback"
    },
    {
      "decision": "NavigationLink drill-down: Stop → DeparturesView → TripDetailsView",
      "rationale": "Standard iOS navigation pattern, matches MVVM coordinator architecture, maintains back stack for user navigation",
      "reference": "IOS_APP_SPECIFICATION.md Section 2 (MVVM + Coordinator), DEVELOPMENT_STANDARDS.md iOS ViewModels",
      "critical_constraint": "Pass stop/departure models via NavigationLink, ViewModels fetch additional data on appear, handle loading/error states"
    },
    {
      "decision": "Modality filter as Picker or segmented control, not separate views",
      "rationale": "Single RouteListView with state-based filtering simpler than multiple coordinator destinations, maintains scroll position when switching modes",
      "reference": "IOS_APP_SPECIFICATION.md Section 5 (feature examples), SwiftUI Picker documentation",
      "critical_constraint": "Use @State var selectedMode: RouteType?, filter routes by selectedMode before grouping alphabetically"
    }
  ],
  "checkpoints": [
    {
      "name": "Stop Search Icon Enhancement",
      "goal": "Search results display transport mode icon (SF Symbol) next to each stop name",
      "backend_work": [],
      "ios_work": [
        "Determine stop's primary route type (query GRDB: most frequent route_type serving stop)",
        "Add computed var stopIcon: Image to Stop model (maps route_type to SF Symbol)",
        "Update SearchView.swift line 32-48: add HStack with Image(systemName: stop.stopIcon) before VStack",
        "Add accessibility label for icon (VoiceOver: 'Train stop', 'Bus stop', etc)"
      ],
      "validation": "Search 'Central' → see train icon, search 'Circular Quay' → see ferry icon"
    },
    {
      "name": "Real Departures Integration",
      "goal": "StopDetailsView shows real upcoming departures from API (not hardcoded placeholders)",
      "backend_work": [
        "Verify GET /stops/{stop_id}/departures returns correct data (already exists line 176-261 in stops.py)",
        "Add missing fields to response: platform, wheelchair_accessible (check Departure model in realtime_service.py)"
      ],
      "ios_work": [
        "Replace StopDetailsView lines 83-101 (mock departures) with NavigationLink to DeparturesView",
        "Pass stop object to DeparturesView(stop: stop)",
        "Update DepartureRow to show platform if available (departure.platform)",
        "Add wheelchair icon if departure.wheelchairAccessible == true"
      ],
      "validation": "Tap stop in search → StopDetailsView → tap 'View Departures' → see real countdown timers, delays, platforms"
    },
    {
      "name": "Trip Details View Implementation",
      "goal": "Tapping departure shows TripDetailsView with intermediary stops and timing",
      "backend_work": [
        "Create backend/app/api/v1/trips.py: GET /trips/{trip_id}",
        "Query patterns + pattern_stops tables for stop sequence",
        "Merge with GTFS-RT trip updates for real-time arrival predictions",
        "Return: {trip_id, route_info, headsign, stops: [{stop_id, stop_name, arrival_time_secs, platform, wheelchair_accessible}]}"
      ],
      "ios_work": [
        "Create Data/Models/Trip.swift with TripStop nested struct",
        "Create Data/Repositories/TripRepository.swift (protocol + impl)",
        "Create Features/Trips/TripDetailsView.swift (List of TripStopRow)",
        "Create Features/Trips/TripDetailsViewModel.swift (@Published var trip, load function)",
        "Wrap DepartureRow in NavigationLink → TripDetailsView(tripId: departure.tripId)"
      ],
      "validation": "Tap departure → see list of intermediary stops with arrival times, platforms, accessibility icons"
    },
    {
      "name": "Route List Modality Filter",
      "goal": "Routes screen has modality picker/tabs (Train/Bus/Metro/Ferry/Tram), shows filtered routes",
      "backend_work": [],
      "ios_work": [
        "Add @State var selectedMode: RouteType? = nil to RouteListView",
        "Add Picker above List: Picker('Mode', selection: $selectedMode) with .all + RouteType.allCases options",
        "Filter routesByType before displaying: if selectedMode != nil, show only selectedMode's routes",
        "Update section headers to show only selected mode when filtered"
      ],
      "validation": "Tap 'Train' → see only train routes, tap 'All' → see all routes grouped by type"
    },
    {
      "name": "Alphabetical Index Navigation",
      "goal": "Route list shows A-Z index on right side, tapping letter scrolls to that section",
      "backend_work": [],
      "ios_work": [
        "Group routes alphabetically within each modality: routes.sorted { $0.displayName < $1.displayName }.grouped by first letter",
        "Create section headers: Text(letter).font(.headline) for each alphabetical group",
        "Add .listStyle(.plain).sectionIndexTitles(alphabetLetters) modifier to List",
        "Define alphabetLetters: ['A', 'B', ..., 'Z'] or compute from actual route names"
      ],
      "validation": "See A-Z index on right side, tap 'T' → scroll to routes starting with T (T1, T2, etc)"
    }
  ],
  "critical_patterns": [
    {
      "pattern": "Repository protocol pattern (async/await, testable)",
      "example_location": "/Users/varunprasad/code/prjs/prj_transport/SydneyTransit/SydneyTransit/Data/Repositories/DeparturesRepository.swift (exists)",
      "reference": "DEVELOPMENT_STANDARDS.md Section 6 (iOS Data Flow), IOS_APP_SPECIFICATION.md Section 4.3"
    },
    {
      "pattern": "API envelope format {data: {...}, meta: {pagination: {...}}}",
      "example_location": "/Users/varunprasad/code/prjs/prj_transport/backend/app/api/v1/stops.py lines 55-72 (nearby stops response)",
      "reference": "INTEGRATION_CONTRACTS.md Section 1.2, DEVELOPMENT_STANDARDS.md Section 3"
    },
    {
      "pattern": "MVVM + @Published state (@MainActor, ObservableObject)",
      "example_location": "/Users/varunprasad/code/prjs/prj_transport/SydneyTransit/SydneyTransit/Features/Departures/DeparturesViewModel.swift (exists)",
      "reference": "DEVELOPMENT_STANDARDS.md Section 6 (ViewModel Responsibilities), IOS_APP_SPECIFICATION.md Section 5.1"
    },
    {
      "pattern": "GRDB FetchableRecord + Codable models",
      "example_location": "/Users/varunprasad/code/prjs/prj_transport/SydneyTransit/SydneyTransit/Data/Models/Stop.swift lines 4-62",
      "reference": "DEVELOPMENT_STANDARDS.md Section 2 (Database Access), IOS_APP_SPECIFICATION.md Section 4.2"
    }
  ],
  "ios_research_needed": [
    "SwiftUI List sectionIndexTitles modifier (A-Z index implementation)",
    "SF Symbols for transport modes: tram.fill, lightrail.fill, train.side.front.car, bus.fill, ferry.fill, cablecar.fill",
    "SwiftUI Picker vs segmented control for modality filter (UX decision)",
    "NavigationLink with complex state passing (departure object → trip details)",
    "Accessibility labels for SF Symbol icons (VoiceOver support)"
  ],
  "external_services_research": [
    "GTFS route_type mapping: 0=Tram/LightRail, 1=Metro, 2=Rail, 3=Bus, 4=Ferry, 5=CableTram, 6=AerialLift, 7=Funicular (from GTFS spec)"
  ],
  "user_blockers": [],
  "acceptance_criteria": [
    "Stop search results show transport mode icon (SF Symbol) next to stop name",
    "Tapping stop in search shows StopDetailsView with 'View Departures' button",
    "Tapping 'View Departures' navigates to DeparturesView showing real API data (not hardcoded)",
    "Each departure row shows: route badge, headsign, countdown timer, delay badge (if >0), platform, wheelchair icon (if accessible)",
    "Tapping departure navigates to TripDetailsView showing intermediary stops with arrival times",
    "Route list has modality picker (Train/Bus/Metro/Ferry/Tram/All) at top",
    "Selecting modality filters routes to show only that type",
    "Route list shows A-Z alphabetical index on right side",
    "Tapping letter in A-Z index scrolls to routes starting with that letter",
    "All views follow MVVM pattern with @Published state and repositories"
  ],
  "related_phases": [
    {
      "phase": "Phase 2",
      "relation": "Phase 2.1 completes partial UI features from Phase 2 real-time implementation (GTFS-RT poller + departures API working, but UI integration incomplete)"
    },
    {
      "phase": "Phase 3",
      "relation": "Phase 2.1 must complete before Phase 3 user features (Apple Sign-In, favorites, sync) to have functional core app"
    }
  ]
}
