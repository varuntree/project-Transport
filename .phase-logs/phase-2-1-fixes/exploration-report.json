{
  "plan_type": "CUSTOM",
  "plan_name": "phase-2-1-fixes",
  "description": "Fix 3 critical bugs: time-filtered departures, trip navigation, missing route modalities",
  "context_summary": "Phase 2.1 implemented real-time departures, trip details, and route categorization. Investigation reveals: (1) Departures fetch live data but don't filter past times, (2) NavigationLink creates loop due to value-based navigation with identical state, (3) iOS RouteType enum missing extended GTFS types (401, 700, 712, 714, 900) causing 4577/4687 routes to be hidden.",

  "affected_systems": [
    {
      "system": "Departures time filtering",
      "current_state": "Returns all departures for entire service day (past + future)",
      "gap": "Missing WHERE clause: ps.departure_offset_secs >= {current_time_secs}",
      "files_affected": [
        "/Users/varunprasad/code/prjs/prj_transport/backend/app/services/realtime_service.py"
      ],
      "data_source": "Supabase pattern_stops + calendar tables → Backend API → iOS (flow working, filter missing)",
      "exact_bug_location": "realtime_service.py line 139-162, query missing time filter"
    },
    {
      "system": "Trip details navigation",
      "current_state": "NavigationLink(value:) creates navigation loop, page reloads",
      "gap": "Using value-based navigation with identical state triggers loop detection",
      "files_affected": [
        "/Users/varunprasad/code/prjs/prj_transport/SydneyTransit/SydneyTransit/Features/Departures/DeparturesView.swift"
      ],
      "navigation_pattern": "Should use direct destination: NavigationLink(destination: TripDetailsView(tripId:))",
      "exact_bug_location": "DeparturesView.swift line 24 + line 31-33"
    },
    {
      "system": "Route modality filtering",
      "current_state": "Only train (type 2) + ferry (type 4) visible, 4577 routes hidden",
      "gap": "iOS RouteType enum missing extended GTFS types: 401 (metro), 700 (bus), 712 (school), 714 (regional), 900 (lightrail)",
      "files_affected": [
        "/Users/varunprasad/code/prjs/prj_transport/SydneyTransit/SydneyTransit/Data/Models/Route.swift"
      ],
      "gtfs_route_types_in_database": "Supabase: {2: 99, 4: 11, 401: 1, 700: 679, 712: 3866, 714: 30, 900: 1} - total 4687 routes",
      "exact_bug_location": "Route.swift line 49-58 enum definition, RouteListView.swift line 86-88 priority filter"
    }
  ],

  "key_decisions": [
    {
      "decision": "Add current_time_secs filter to departures SQL query",
      "rationale": "Query fetches all day's departures (0-86400 secs), UI only needs future ones",
      "critical_constraint": "Filter at SQL level (not iOS) to reduce payload, use now_secs parameter from API endpoint"
    },
    {
      "decision": "Change NavigationLink to direct destination pattern",
      "rationale": "Value-based navigation with Hashable Departure creates loop detection (identical state before/after navigation)",
      "critical_constraint": "Remove .navigationDestination(for: Departure.self), use inline destination: TripDetailsView(tripId:)"
    },
    {
      "decision": "Extend RouteType enum with NSW extended types",
      "rationale": "GTFS Extended Route Types spec allows 100-117 for bus variants, 400-499 for rail variants. NSW uses 401, 700, 712, 714, 900",
      "critical_constraint": "Map 401→metro, 700→bus, 712→schoolBus, 714→regionalBus, 900→lightRail. Update priority array to include all used types"
    }
  ],

  "checkpoints": [
    {
      "name": "Fix departures time filtering",
      "goal": "Show only future departures (next 2 hours), hide past",
      "backend_work": [
        "realtime_service.py: Add AND ps.departure_offset_secs >= {time_secs} to WHERE clause",
        "Verify calendar query uses now_date for service day lookup",
        "Test with curl at various times"
      ],
      "ios_work": [],
      "validation": "Departures list shows 10-20 upcoming services, no past times"
    },
    {
      "name": "Fix trip navigation loop",
      "goal": "Tapping departure navigates to TripDetailsView",
      "backend_work": [],
      "ios_work": [
        "DeparturesView.swift: Replace NavigationLink(value: departure) with NavigationLink(destination: TripDetailsView(tripId: departure.tripId))",
        "Remove .navigationDestination(for: Departure.self)"
      ],
      "validation": "Tap any departure → new screen shows trip stops list"
    },
    {
      "name": "Fix missing route modalities",
      "goal": "Route list shows all 4687 routes across 6 modalities",
      "backend_work": [],
      "ios_work": [
        "Route.swift: Add cases to RouteType enum: metro=401, regularBus=700, schoolBus=712, regionalBus=714, lightRail=900",
        "Update displayName, color switches",
        "RouteListView.swift: Update priority array with new types"
      ],
      "validation": "Segmented control shows 6+ modalities, counts correct"
    },
    {
      "name": "Commit realtime_service mode heuristic",
      "goal": "Commit uncommitted improvements to determine_mode",
      "backend_work": [
        "Review git diff backend/app/services/realtime_service.py",
        "Test mode determination for mixed stops",
        "Commit if correct"
      ],
      "ios_work": [],
      "validation": "Git status clean, mode heuristic handles MFF/IWLR/SMNW"
    }
  ],

  "acceptance_criteria": [
    "Departures show only future times (no past services), max 20 results",
    "Tapping any departure navigates to TripDetailsView (no page reload)",
    "Route list shows: Train, Metro, Bus, School Bus, Regional Bus, Ferry, Light Rail",
    "Switching modalities shows correct counts: Regular Bus ~679, School Bus ~3866",
    "Alphabetical index navigation works for all modalities"
  ],

  "user_blockers": [],

  "data_verification": {
    "supabase_routes": "4687 rows, types: {2: 99, 4: 11, 401: 1, 700: 679, 712: 3866, 714: 30, 900: 1}",
    "backend_api": "GET /api/v1/routes returns all 4687 routes - API correct",
    "ios_bundled_db": "Same distribution - data pipeline correct"
  },

  "fix_complexity": {
    "departures_time_filter": "Low (1 line SQL, 5 min)",
    "trip_navigation": "Low (1 line SwiftUI, 5 min)",
    "route_modalities": "Medium (enum cases + switches, 20 min)"
  }
}
