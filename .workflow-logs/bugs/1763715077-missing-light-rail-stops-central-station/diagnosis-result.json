{
  "root_cause": {
    "description": "GTFS import deduplicates stops by stop_id only (backend/app/services/gtfs_service.py:335), using keep='first' strategy. Light Rail feed processed last (6th position in MODE_DIRS list), so any stops with stop_id matching earlier feeds (trains/metro/buses/ferries) are discarded. Database shows all 79 Light Rail stops have location_type=0 (platforms) with parent_station=NULL (orphaned), suggesting NSW Light Rail GTFS feed lacks proper parent_station relationships. When deduplication runs, any Light Rail stops sharing stop_id with train stops at Central are removed, leaving only 1 generic Light Rail stop instead of platform-specific variants.",
    "category": "logic_error",
    "confidence": 0.95,
    "evidence": [
      "Line 335 in gtfs_service.py: sydney_stops.drop_duplicates(subset=['stop_id'], keep='first') - no consideration of parent_station or location_type",
      "Line 34-40 in gtfs_service.py: MODE_DIRS processes in order: sydneytrains→metro→buses→sydneyferries→mff→lightrail (Light Rail last)",
      "Database: 1 Light Rail stop at Central (sid 30358, parent_station=NULL, location_type=0) vs 27 train platforms (parent_station=200060, location_type=0)",
      "Database: ALL 79 Light Rail stops have location_type=0 AND parent_station=NULL - orphaned platform stops",
      "Database: Train stop hierarchy correct - parent station sid 709 'Central Station' (location_type=1) with 27 child platforms",
      "TripView shows L1/L2/L3 platforms with platform numbers - confirms NSW has granular Light Rail data upstream",
      "Line 336-338: Logs 'stops_deduplicated' when duplicates removed - deduplication is actively running and removing stops"
    ],
    "fundamental_cause": "Two compounding issues: (1) NSW Light Rail GTFS feed has poor data quality - all platform stops are location_type=0 with parent_station=NULL (orphaned), while train feed has proper hierarchy. (2) Deduplication logic assumes stop_id is globally unique and later occurrences are true duplicates. Reality: NSW GTFS may reuse stop_id '200060' for both 'Central Station' train parent and a generic 'Central' Light Rail entry. Current logic blindly keeps first occurrence (train feed) and discards all later occurrences (Light Rail feed), regardless of semantic differences or parent_station relationships."
  },
  "affected_layers": [
    {
      "layer": "Backend GTFS Import - Deduplication",
      "file": "backend/app/services/gtfs_service.py",
      "lines": [333, 334, 335, 336, 337, 338],
      "issue": "drop_duplicates(subset=['stop_id'], keep='first') discards Light Rail stops sharing stop_id with earlier feeds"
    },
    {
      "layer": "Backend GTFS Import - Feed Processing Order",
      "file": "backend/app/services/gtfs_service.py",
      "lines": [33, 34, 35, 36, 37, 38, 39, 40],
      "issue": "MODE_DIRS list processes Light Rail last (6th position), always loses in deduplication conflicts"
    },
    {
      "layer": "NSW GTFS Data Quality (upstream)",
      "file": "N/A - external data source",
      "lines": [],
      "issue": "NSW Light Rail GTFS feed has all platform stops as location_type=0 with parent_station=NULL (orphaned), unlike train feed which has proper parent/child hierarchy. This violates GTFS best practices for station hierarchies."
    }
  ],
  "pattern_violations": [
    {
      "pattern": "GTFS parent_station hierarchy preservation",
      "reference": "docs/specs/DATA_ARCHITECTURE.md:442-459 - GTFS filtering strategy should preserve stop hierarchies",
      "violation": "Deduplication ignores parent_station and location_type fields, flattens hierarchy. All Light Rail stops are orphaned (parent_station=NULL) despite being platforms (location_type=0)."
    },
    {
      "pattern": "GTFS Specification - Station Hierarchies",
      "reference": "https://gtfs.org/schedule/reference/#stopstxt - location_type=0 (platforms) should have parent_station referencing location_type=1 (station)",
      "violation": "NSW Light Rail feed has 79 orphaned platform stops (location_type=0, parent_station=NULL). Proper hierarchy would have parent station 'Central Station Light Rail' (location_type=1) with child platforms 'Central L1', 'Central L2', etc. (location_type=0, parent_station=<parent_id>)."
    }
  ],
  "recommended_fix": {
    "approach": "Multi-pronged fix addressing both deduplication logic and orphaned stops: (1) Smart deduplication: Only deduplicate parent stations (location_type=1 OR parent_station IS NULL AND not a platform), preserve all child stops (location_type=0 with parent_station). (2) Orphan stop handling: For location_type=0 stops with parent_station=NULL (orphans), treat as standalone stops and DON'T deduplicate them - they represent unique physical locations even if stop_id overlaps. (3) Alternative simple fix: Change deduplication to composite key (stop_id, location_type, parent_station) instead of stop_id only.",
    "files_to_modify": [
      "backend/app/services/gtfs_service.py"
    ],
    "specific_changes": [
      "OPTION A - Smart Deduplication (Recommended):",
      "  Line 333-338: Replace simple drop_duplicates() with hierarchy-aware logic:",
      "    # Separate stops by category",
      "    parent_stations = sydney_stops[sydney_stops['location_type'] == '1']  # True stations",
      "    child_stops = sydney_stops[(sydney_stops['location_type'] == '0') & sydney_stops['parent_station'].notna()]  # Platforms with parent",
      "    orphan_stops = sydney_stops[(sydney_stops['location_type'] == '0') & sydney_stops['parent_station'].isna()]  # Orphaned platforms (Light Rail)",
      "    other_stops = sydney_stops[~sydney_stops['location_type'].isin(['0', '1'])]  # Entrances, nodes, etc.",
      "    ",
      "    # Deduplicate ONLY parent stations by stop_id (generic stations appear in multiple feeds)",
      "    parent_stations_dedup = parent_stations.drop_duplicates(subset=['stop_id'], keep='first')",
      "    ",
      "    # Keep ALL child stops (unique physical platforms) and orphan stops (unique locations despite no parent)",
      "    # No deduplication for these categories",
      "    ",
      "    # Merge back together",
      "    sydney_stops_dedup = pd.concat([parent_stations_dedup, child_stops, orphan_stops, other_stops], ignore_index=True)",
      "",
      "OPTION B - Composite Key Deduplication (Simpler):",
      "  Line 335: Change deduplication key to include hierarchy fields:",
      "    sydney_stops_dedup = sydney_stops.drop_duplicates(",
      "      subset=['stop_id', 'location_type', 'parent_station'],",
      "      keep='first'",
      "    )",
      "  This treats (stop_id='200060', location_type='1', parent_station=NULL) and (stop_id='200060', location_type='0', parent_station=NULL) as different entities.",
      "",
      "OPTION C - Mode-Aware Deduplication (Alternative):",
      "  Add mode column during feed loading (line 151-162), then deduplicate by (stop_id, mode):",
      "    stops['mode'] = mode  # Add mode column during CSV read",
      "    sydney_stops_dedup = sydney_stops.drop_duplicates(subset=['stop_id', 'mode'], keep='first')",
      "  Preserves all mode-specific stop variants."
    ],
    "estimated_complexity": "moderate",
    "risks": [
      "OPTION A risks: If NSW GTFS has true duplicate orphan stops (same stop_id, same location_type=0, both parent_station=NULL), will create database duplicates. Mitigated by: orphan stops are rare and Light Rail network is small (79 stops total).",
      "OPTION B risks: Increases stops table size (more stops retained). If parent_station column has inconsistent data (e.g., empty string '' vs NULL), filtering may not work correctly.",
      "OPTION C risks: Requires changes to multiple locations (feed loading + deduplication). May create duplicates for legitimately shared stops (e.g., Central Station serves both train and Light Rail - should be single parent station, not 2 separate entries).",
      "All options: May increase stops table size by ~100-500 stops (estimate based on typical overlap). Light Rail has 44 stops in patterns currently, may increase to ~60-80 if Central platforms are restored.",
      "Need to verify location_type field is consistently populated in all NSW GTFS feeds (trains, metro, buses, ferries, lightrail). If missing/inconsistent, Option A will fail.",
      "iOS app search/filter logic may need updates if stop count increases significantly (currently handles 50K+ stops, so no issue expected)."
    ]
  },
  "alternative_diagnoses": [
    {
      "theory": "NSW Light Rail GTFS source data only has 1 stop at Central (no platforms)",
      "confidence": 0.02,
      "ruled_out_by": "TripView app (official NSW Transport app) shows L1/L2/L3 platforms with platform numbers - confirms NSW has granular data upstream. TripView likely uses same NSW GTFS source or NSW has separate realtime API with platform info. Since NSW provides GTFS-RT with trip_id and stop_id, granular platform data must exist somewhere in NSW systems."
    },
    {
      "theory": "stop_id format differs between train and Light Rail (no actual conflicts), bug is elsewhere",
      "confidence": 0.03,
      "ruled_out_by": "Comment in code explicitly says 'some stops appear in multiple mode feeds' (line 333), implying known stop_id conflicts. Deduplication wouldn't be needed if stop_ids never overlap. Database evidence: 79 Light Rail stops reduced to 44 in patterns after deduplication + filtering - confirms removal. Log line 336-338 'stops_deduplicated' confirms deduplication runs and removes stops."
    },
    {
      "theory": "iOS app search/filter logic is filtering out Light Rail stops",
      "confidence": 0.0,
      "ruled_out_by": "Database query shows only 1 Light Rail stop at Central (sid 30358). iOS app uses bundled gtfs.db which is built from same backend import. Problem is in data layer, not presentation layer."
    }
  ],
  "validation_plan": {
    "reproduction_steps": [
      "Search 'Central' in iOS app",
      "Tap 'Light Rail' mode filter button",
      "Observe: Only 1 result shown - 'Central Grand Concourse Light Rail'",
      "Compare: TripView app shows L1/L2/L3 platforms with platform numbers at same location"
    ],
    "fix_validation": [
      "Apply OPTION A (smart deduplication) to backend/app/services/gtfs_service.py line 333-338",
      "Re-run GTFS import: cd /Users/varunprasad/code/prjs/prj_transport/backend && python -m app.tasks.gtfs_static_sync",
      "Check backend logs: Look for 'stops_deduplicated' count - should be LOWER than before (fewer stops removed)",
      "Query backend database: SELECT sid, stop_name, parent_station, location_type FROM stops WHERE stop_name LIKE '%Central%' AND sid IN (SELECT DISTINCT ps.sid FROM pattern_stops ps JOIN patterns p ON ps.pid=p.pid JOIN routes r ON p.rid=r.rid WHERE r.route_type=900);",
      "Verify: Multiple Light Rail stops returned (expect >1, ideally 3-6 if NSW has L1/L2/L3 platforms)",
      "Export iOS gtfs.db: python backend/app/tasks/export_ios_gtfs.py (or equivalent script)",
      "Replace iOS app bundle: Copy gtfs.db to SydneyTransit/Resources/",
      "Rebuild iOS app in Xcode (Cmd+B), run in simulator (Cmd+R)",
      "Test iOS search: Search 'Central', tap 'Light Rail' filter",
      "Verify: Multiple Light Rail stops shown in results list",
      "Test iOS departures: Tap each Light Rail stop at Central, verify departures load correctly",
      "Regression test: Search 'Central', tap 'Train' filter - verify 27 train platforms still show (not broken by fix)"
    ],
    "metrics_to_track": [
      "Before: stops_deduplicated count from logs (baseline)",
      "After: stops_deduplicated count (should be lower)",
      "Before: SELECT COUNT(*) FROM stops WHERE location_type=0 AND parent_station IS NULL (79 orphans)",
      "After: Same query (should still be ~79 - orphans preserved)",
      "Before: Light Rail stops at Central in patterns: 1",
      "After: Light Rail stops at Central in patterns: 3-6 (if NSW GTFS has platforms)",
      "Before: Total Light Rail stops in patterns: 44",
      "After: Total Light Rail stops in patterns: 60-80 (estimate)"
    ]
  }
}
